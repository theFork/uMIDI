<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>uMIDI: /home/haggl/repositories/uMIDI/software/src/lib/serial_communication.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">uMIDI
   </div>
   <div id="projectbrief">The swiss army knife for quick and easy developement of MIDI applications.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_c8fa76d8dc1b9e06ff8aeb3121608b1b.html">software</a></li><li class="navelem"><a class="el" href="dir_0a6976b261bfea925410a9d3b510969e.html">src</a></li><li class="navelem"><a class="el" href="dir_85743a6d44e2a34b0cf5e56859c4c51a.html">lib</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">serial_communication.c File Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Implementation of the serial communication module.  
<a href="#details">More...</a></p>
<div class="textblock"><code>#include &lt;stdlib.h&gt;</code><br />
<code>#include &lt;string.h&gt;</code><br />
<code>#include &lt;avr/wdt.h&gt;</code><br />
<code>#include &quot;xboot/xbootapi.h&quot;</code><br />
<code>#include &quot;<a class="el" href="background__tasks_8h_source.html">background_tasks.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="usb_8h_source.html">usb.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="serial__communication_8h_source.html">serial_communication.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="system_8h_source.html">system.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for serial_communication.c:</div>
<div class="dyncontent">
<div class="center"><img src="serial__communication_8c__incl.png" border="0" usemap="#_2home_2haggl_2repositories_2uMIDI_2software_2src_2lib_2serial__communication_8c" alt=""/></div>
<map name="_2home_2haggl_2repositories_2uMIDI_2software_2src_2lib_2serial__communication_8c" id="_2home_2haggl_2repositories_2uMIDI_2software_2src_2lib_2serial__communication_8c">
<area shape="rect" id="node10" href="background__tasks_8h.html" title="Background task scheduler. " alt="" coords="909,131,1048,158"/>
<area shape="rect" id="node12" href="usb_8h.html" title="USB CDC device API. " alt="" coords="529,131,583,158"/>
<area shape="rect" id="node48" href="serial__communication_8h.html" title="Serial communication module. " alt="" coords="1073,131,1231,158"/>
<area shape="rect" id="node49" href="system_8h.html" title="System configuration procedures. " alt="" coords="8077,131,8153,158"/>
</map>
</div>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a5d9930b9bb7150cc90ada5e3f653b978"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a5d9930b9bb7150cc90ada5e3f653b978">exec_help</a> (void)</td></tr>
<tr class="memdesc:a5d9930b9bb7150cc90ada5e3f653b978"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handler for the <code>help</code> command.  <a href="#a5d9930b9bb7150cc90ada5e3f653b978">More...</a><br /></td></tr>
<tr class="separator:a5d9930b9bb7150cc90ada5e3f653b978"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a22fffbdce8e4dfe6e774b3b539ea7266"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a22fffbdce8e4dfe6e774b3b539ea7266">exec_update</a> (const char *const command)</td></tr>
<tr class="memdesc:a22fffbdce8e4dfe6e774b3b539ea7266"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handler for the <code>update</code> command.  <a href="#a22fffbdce8e4dfe6e774b3b539ea7266">More...</a><br /></td></tr>
<tr class="separator:a22fffbdce8e4dfe6e774b3b539ea7266"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a1ad3ecdf554585ee5b0378246bf3d203"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a1ad3ecdf554585ee5b0378246bf3d203">execute_command</a> (const char *const command)</td></tr>
<tr class="memdesc:a1ad3ecdf554585ee5b0378246bf3d203"><td class="mdescLeft">&#160;</td><td class="mdescRight">Executes an interactive command.  <a href="#a1ad3ecdf554585ee5b0378246bf3d203">More...</a><br /></td></tr>
<tr class="separator:a1ad3ecdf554585ee5b0378246bf3d203"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3e2ec2b8d89902d628e67510fe2ffc74"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a3e2ec2b8d89902d628e67510fe2ffc74">print_command_from_history</a> (const int8_t <a class="el" href="adc_8c.html#ac681806181c80437cfab37335f62ff39">offset</a>)</td></tr>
<tr class="memdesc:a3e2ec2b8d89902d628e67510fe2ffc74"><td class="mdescLeft">&#160;</td><td class="mdescRight">Prints out a command from the history.  <a href="#a3e2ec2b8d89902d628e67510fe2ffc74">More...</a><br /></td></tr>
<tr class="separator:a3e2ec2b8d89902d628e67510fe2ffc74"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5c514980feb8a74189c53fab5d15949f"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a5c514980feb8a74189c53fab5d15949f">handle_escape_sequence</a> (const char data)</td></tr>
<tr class="memdesc:a5c514980feb8a74189c53fab5d15949f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Handles ANSI escape sequences.  <a href="#a5c514980feb8a74189c53fab5d15949f">More...</a><br /></td></tr>
<tr class="separator:a5c514980feb8a74189c53fab5d15949f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add165fc79fbb4c43bd4b7c2a7406eafa"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#add165fc79fbb4c43bd4b7c2a7406eafa">process_command_char</a> (void)</td></tr>
<tr class="memdesc:add165fc79fbb4c43bd4b7c2a7406eafa"><td class="mdescLeft">&#160;</td><td class="mdescRight">Processes a command character.  <a href="#add165fc79fbb4c43bd4b7c2a7406eafa">More...</a><br /></td></tr>
<tr class="separator:add165fc79fbb4c43bd4b7c2a7406eafa"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a178a240a5e4b7629eb33cc02b41981b2"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a178a240a5e4b7629eb33cc02b41981b2">process_update_data</a> (void)</td></tr>
<tr class="memdesc:a178a240a5e4b7629eb33cc02b41981b2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Processes binary data arriving over USB during the update process.  <a href="#a178a240a5e4b7629eb33cc02b41981b2">More...</a><br /></td></tr>
<tr class="separator:a178a240a5e4b7629eb33cc02b41981b2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a983fd396fb196e2772ce53c741d91aa5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a983fd396fb196e2772ce53c741d91aa5">init_serial_communication</a> (const struct <a class="el" href="structserial__command.html">serial_command</a> *const commands, uint8_t commands_size)</td></tr>
<tr class="separator:a983fd396fb196e2772ce53c741d91aa5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aef8ac4747eff8ad8f2115bea2a909733"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#aef8ac4747eff8ad8f2115bea2a909733">serial_communication_task</a> (void)</td></tr>
<tr class="memdesc:aef8ac4747eff8ad8f2115bea2a909733"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main task for USB communication.  <a href="#aef8ac4747eff8ad8f2115bea2a909733">More...</a><br /></td></tr>
<tr class="separator:aef8ac4747eff8ad8f2115bea2a909733"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a3f73a09e76180a8cfb4e5b2008765680"><td class="memItemLeft" align="right" valign="top">static char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a3f73a09e76180a8cfb4e5b2008765680">cmd_buffer</a> [<a class="el" href="serial__communication_8h.html#a8a0465f8e8bbe71e4d6e8011e975bf75">CMD_BUFFER_SIZE</a>] = &quot;&quot;</td></tr>
<tr class="memdesc:a3f73a09e76180a8cfb4e5b2008765680"><td class="mdescLeft">&#160;</td><td class="mdescRight">Buffer for incoming commands.  <a href="#a3f73a09e76180a8cfb4e5b2008765680">More...</a><br /></td></tr>
<tr class="separator:a3f73a09e76180a8cfb4e5b2008765680"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e83dd0470f59e8817d6434965f1d4f2"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a4e83dd0470f59e8817d6434965f1d4f2">cmd_buffer_index</a> = 0</td></tr>
<tr class="memdesc:a4e83dd0470f59e8817d6434965f1d4f2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Command buffer write index.  <a href="#a4e83dd0470f59e8817d6434965f1d4f2">More...</a><br /></td></tr>
<tr class="separator:a4e83dd0470f59e8817d6434965f1d4f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a93864e2869565395f705762be776fd59"><td class="memItemLeft" align="right" valign="top">static char&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a93864e2869565395f705762be776fd59">cmd_history</a> [<a class="el" href="serial__communication_8h.html#abbde6302d43aed05228391c120e4bec5">CMD_HISTORY_SIZE</a>][<a class="el" href="serial__communication_8h.html#a8a0465f8e8bbe71e4d6e8011e975bf75">CMD_BUFFER_SIZE</a>] = {&quot;&quot;,}</td></tr>
<tr class="memdesc:a93864e2869565395f705762be776fd59"><td class="mdescLeft">&#160;</td><td class="mdescRight">Buffer for incoming commands.  <a href="#a93864e2869565395f705762be776fd59">More...</a><br /></td></tr>
<tr class="separator:a93864e2869565395f705762be776fd59"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a39aed4ba82d44bccbec76f8fe0d057a5"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a39aed4ba82d44bccbec76f8fe0d057a5">cmd_history_index</a> = 0</td></tr>
<tr class="memdesc:a39aed4ba82d44bccbec76f8fe0d057a5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Command buffer write index.  <a href="#a39aed4ba82d44bccbec76f8fe0d057a5">More...</a><br /></td></tr>
<tr class="separator:a39aed4ba82d44bccbec76f8fe0d057a5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2d4d80988a07155f9e7b1f877f15bcef"><td class="memItemLeft" align="right" valign="top">static const struct <a class="el" href="structserial__command.html">serial_command</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a2d4d80988a07155f9e7b1f877f15bcef">user_commands</a></td></tr>
<tr class="memdesc:a2d4d80988a07155f9e7b1f877f15bcef"><td class="mdescLeft">&#160;</td><td class="mdescRight">Array of user-defined commands.  <a href="#a2d4d80988a07155f9e7b1f877f15bcef">More...</a><br /></td></tr>
<tr class="separator:a2d4d80988a07155f9e7b1f877f15bcef"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a973a9023c9bf0e9bb5fbf11077e993c6"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a973a9023c9bf0e9bb5fbf11077e993c6">user_commands_size</a></td></tr>
<tr class="memdesc:a973a9023c9bf0e9bb5fbf11077e993c6"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of registered user commands.  <a href="#a973a9023c9bf0e9bb5fbf11077e993c6">More...</a><br /></td></tr>
<tr class="separator:a973a9023c9bf0e9bb5fbf11077e993c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8409a0d351d4fba2eeef26a7dcc585a8"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a8409a0d351d4fba2eeef26a7dcc585a8">reset</a> = false</td></tr>
<tr class="memdesc:a8409a0d351d4fba2eeef26a7dcc585a8"><td class="mdescLeft">&#160;</td><td class="mdescRight">Device reset flag.  <a href="#a8409a0d351d4fba2eeef26a7dcc585a8">More...</a><br /></td></tr>
<tr class="separator:a8409a0d351d4fba2eeef26a7dcc585a8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:acfccd4d90a3c71bf5622fe5a41696e4c"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#acfccd4d90a3c71bf5622fe5a41696e4c">update_in_progress</a> = false</td></tr>
<tr class="memdesc:acfccd4d90a3c71bf5622fe5a41696e4c"><td class="mdescLeft">&#160;</td><td class="mdescRight">This flag indicates if an update is in progress.  <a href="#acfccd4d90a3c71bf5622fe5a41696e4c">More...</a><br /></td></tr>
<tr class="separator:acfccd4d90a3c71bf5622fe5a41696e4c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4fb35aa98ca6dc717905f0a5249b7e34"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a4fb35aa98ca6dc717905f0a5249b7e34">update_bytes_pending</a> = 0</td></tr>
<tr class="memdesc:a4fb35aa98ca6dc717905f0a5249b7e34"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of pending update bytes.  <a href="#a4fb35aa98ca6dc717905f0a5249b7e34">More...</a><br /></td></tr>
<tr class="separator:a4fb35aa98ca6dc717905f0a5249b7e34"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aca521b5f12417588e4357d51fc94ed93"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#aca521b5f12417588e4357d51fc94ed93">num_pages</a> = 0</td></tr>
<tr class="memdesc:aca521b5f12417588e4357d51fc94ed93"><td class="mdescLeft">&#160;</td><td class="mdescRight">Number of pages required for update.  <a href="#aca521b5f12417588e4357d51fc94ed93">More...</a><br /></td></tr>
<tr class="separator:aca521b5f12417588e4357d51fc94ed93"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7d34327aa3cb1d929b9beee97feee89e"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#a7d34327aa3cb1d929b9beee97feee89e">expected_crc</a> = 0</td></tr>
<tr class="memdesc:a7d34327aa3cb1d929b9beee97feee89e"><td class="mdescLeft">&#160;</td><td class="mdescRight">CRC of the firmware.  <a href="#a7d34327aa3cb1d929b9beee97feee89e">More...</a><br /></td></tr>
<tr class="separator:a7d34327aa3cb1d929b9beee97feee89e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab7a2c381df96f03f0c378bcb5d170588"><td class="memItemLeft" align="right" valign="top">static uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#ab7a2c381df96f03f0c378bcb5d170588">page_buffer</a> [SPM_PAGESIZE] = &quot;&quot;</td></tr>
<tr class="memdesc:ab7a2c381df96f03f0c378bcb5d170588"><td class="mdescLeft">&#160;</td><td class="mdescRight">Buffer for application pages.  <a href="#ab7a2c381df96f03f0c378bcb5d170588">More...</a><br /></td></tr>
<tr class="separator:ab7a2c381df96f03f0c378bcb5d170588"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abf98eb7f158abad9aa3ca04f11f23bdf"><td class="memItemLeft" align="right" valign="top">static uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#abf98eb7f158abad9aa3ca04f11f23bdf">page_buffer_index</a> = 0</td></tr>
<tr class="memdesc:abf98eb7f158abad9aa3ca04f11f23bdf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Page buffer write index.  <a href="#abf98eb7f158abad9aa3ca04f11f23bdf">More...</a><br /></td></tr>
<tr class="separator:abf98eb7f158abad9aa3ca04f11f23bdf"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af64bc361beb78e49db04cb799ad26d29"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#af64bc361beb78e49db04cb799ad26d29">temp_app_addr</a> = 0</td></tr>
<tr class="memdesc:af64bc361beb78e49db04cb799ad26d29"><td class="mdescLeft">&#160;</td><td class="mdescRight">Temporary application write address.  <a href="#af64bc361beb78e49db04cb799ad26d29">More...</a><br /></td></tr>
<tr class="separator:af64bc361beb78e49db04cb799ad26d29"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab76f65c0463ee633890ea09d82896c95"><td class="memItemLeft" align="right" valign="top">static bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="serial__communication_8c.html#ab76f65c0463ee633890ea09d82896c95">echo_on</a> = true</td></tr>
<tr class="memdesc:ab76f65c0463ee633890ea09d82896c95"><td class="mdescLeft">&#160;</td><td class="mdescRight">Terminal echo flag.  <a href="#ab76f65c0463ee633890ea09d82896c95">More...</a><br /></td></tr>
<tr class="separator:ab76f65c0463ee633890ea09d82896c95"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Implementation of the serial communication module. </p>
<dl class="section see"><dt>See also</dt><dd>module header </dd></dl>
</div><h2 class="groupheader">Function Documentation</h2>
<a class="anchor" id="a5d9930b9bb7150cc90ada5e3f653b978"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static bool exec_help </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Handler for the <code>help</code> command. </p>

</div>
</div>
<a class="anchor" id="a22fffbdce8e4dfe6e774b3b539ea7266"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static bool exec_update </td>
          <td>(</td>
          <td class="paramtype">const char *const&#160;</td>
          <td class="paramname"><em>command</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Handler for the <code>update</code> command. </p>

</div>
</div>
<a class="anchor" id="a1ad3ecdf554585ee5b0378246bf3d203"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void execute_command </td>
          <td>(</td>
          <td class="paramtype">const char *const&#160;</td>
          <td class="paramname"><em>command</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Executes an interactive command. </p>
<p>Tries to match the beginning of the supplied string to the registered commands. If a matching command string is found, its handler is invoked. In case no suitable command could be matched, or the executed handler returns a non-zero value, an error message is sent. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">command</td><td>the full command line as a C-string </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a5c514980feb8a74189c53fab5d15949f"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static bool handle_escape_sequence </td>
          <td>(</td>
          <td class="paramtype">const char&#160;</td>
          <td class="paramname"><em>data</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Handles ANSI escape sequences. </p>
<dl class="section return"><dt>Returns</dt><dd><code>true</code> as long as we are in the middle of an escape sequence </dd></dl>

</div>
</div>
<a class="anchor" id="a983fd396fb196e2772ce53c741d91aa5"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void init_serial_communication </td>
          <td>(</td>
          <td class="paramtype">const struct <a class="el" href="structserial__command.html">serial_command</a> *const&#160;</td>
          <td class="paramname"><em>commands</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>commands_size</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a class="anchor" id="a3e2ec2b8d89902d628e67510fe2ffc74"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void print_command_from_history </td>
          <td>(</td>
          <td class="paramtype">const int8_t&#160;</td>
          <td class="paramname"><em>offset</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Prints out a command from the history. </p>
<p>Clears out the last printed command first. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">offset</td><td>offset of the command to be printed </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="add165fc79fbb4c43bd4b7c2a7406eafa"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void process_command_char </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Processes a command character. </p>
<p>If the supplied character is a carriage return, the command line read so far is executed, otherwise the character is simply appended to a (circular!) buffer. If <a class="el" href="serial__communication_8c.html#ab76f65c0463ee633890ea09d82896c95" title="Terminal echo flag. ">echo_on</a> is set, the character is also immediately sent back to the sender, whereby carriage return characters are replaced by <a class="el" href="usb_8h.html#a87dfb7d8e8c6b2837843a2074eff3566" title="Newline character sequence. ">USB_NEWLINE</a>. </p>

</div>
</div>
<a class="anchor" id="a178a240a5e4b7629eb33cc02b41981b2"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">static void process_update_data </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Processes binary data arriving over USB during the update process. </p>
<p>If the supplied character is a carriage return, the command line read so far is executed, otherwise the character is simply appended to a (circular!) buffer. </p>

</div>
</div>
<a class="anchor" id="aef8ac4747eff8ad8f2115bea2a909733"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void serial_communication_task </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main task for USB communication. </p>
<p>This task must be run as a slow or medium speed task in order to enable USB communication and firmware updates. It processes commands arriving on the bus and takes required actions by calling registered handler functions. </p><dl class="section see"><dt>See also</dt><dd><a class="el" href="serial__communication_8h.html#a81374ca7329e4804cf4c64f491fadc09" title="Initializes the USB communication module. ">init_serial_communication</a> </dd></dl>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a class="anchor" id="a3f73a09e76180a8cfb4e5b2008765680"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char cmd_buffer[<a class="el" href="serial__communication_8h.html#a8a0465f8e8bbe71e4d6e8011e975bf75">CMD_BUFFER_SIZE</a>] = &quot;&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Buffer for incoming commands. </p>

</div>
</div>
<a class="anchor" id="a4e83dd0470f59e8817d6434965f1d4f2"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t cmd_buffer_index = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Command buffer write index. </p>

</div>
</div>
<a class="anchor" id="a93864e2869565395f705762be776fd59"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">char cmd_history[<a class="el" href="serial__communication_8h.html#abbde6302d43aed05228391c120e4bec5">CMD_HISTORY_SIZE</a>][<a class="el" href="serial__communication_8h.html#a8a0465f8e8bbe71e4d6e8011e975bf75">CMD_BUFFER_SIZE</a>] = {&quot;&quot;,}</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Buffer for incoming commands. </p>

</div>
</div>
<a class="anchor" id="a39aed4ba82d44bccbec76f8fe0d057a5"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t cmd_history_index = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Command buffer write index. </p>

</div>
</div>
<a class="anchor" id="ab76f65c0463ee633890ea09d82896c95"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool echo_on = true</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Terminal echo flag. </p>
<p>When this flag is set, received bytes are immediately echoed back to provide a shell-like experience. </p>

</div>
</div>
<a class="anchor" id="a7d34327aa3cb1d929b9beee97feee89e"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t expected_crc = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>CRC of the firmware. </p>

</div>
</div>
<a class="anchor" id="aca521b5f12417588e4357d51fc94ed93"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t num_pages = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Number of pages required for update. </p>

</div>
</div>
<a class="anchor" id="ab7a2c381df96f03f0c378bcb5d170588"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t page_buffer[SPM_PAGESIZE] = &quot;&quot;</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Buffer for application pages. </p>

</div>
</div>
<a class="anchor" id="abf98eb7f158abad9aa3ca04f11f23bdf"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t page_buffer_index = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Page buffer write index. </p>

</div>
</div>
<a class="anchor" id="a8409a0d351d4fba2eeef26a7dcc585a8"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool reset = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Device reset flag. </p>
<p>This flag is set when the device receives the <code>reset</code> command. The device will then stop receiving data, send a shutdown message, count down a timeout and reset itself. </p>

</div>
</div>
<a class="anchor" id="af64bc361beb78e49db04cb799ad26d29"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t temp_app_addr = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Temporary application write address. </p>

</div>
</div>
<a class="anchor" id="a4fb35aa98ca6dc717905f0a5249b7e34"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint16_t update_bytes_pending = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Number of pending update bytes. </p>

</div>
</div>
<a class="anchor" id="acfccd4d90a3c71bf5622fe5a41696e4c"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">bool update_in_progress = false</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>This flag indicates if an update is in progress. </p>

</div>
</div>
<a class="anchor" id="a2d4d80988a07155f9e7b1f877f15bcef"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">const struct <a class="el" href="structserial__command.html">serial_command</a>* user_commands</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Array of user-defined commands. </p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="serial__communication_8c.html#a983fd396fb196e2772ce53c741d91aa5">init_serial_communication</a> </dd></dl>

</div>
</div>
<a class="anchor" id="a973a9023c9bf0e9bb5fbf11077e993c6"></a>
<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t user_commands_size</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Number of registered user commands. </p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Jun 26 2016 21:08:51 for uMIDI by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
